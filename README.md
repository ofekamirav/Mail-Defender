# Mail Defender - Phishing Detection System

**Mail Defender** is a hybrid phishing detection system for Gmail. It combines machine learning with heuristic analysis to classify emails as Safe, Suspicious or Phishing. The system features an **Active Learning** loop, allowing the model to retrain and improve based on real-time user feedback.

The solution is delivered as a **Gmail Add-on** (Google Apps Script) backed by a **Flask REST API**.

## System Architecture

The project consists of two main components:

1.  **Backend (Python/FastAPI):** Handles the logic, ML model training, heuristic analysis and data storage.
2.  **Frontend (Google Apps Script):** A Gmail Add-on that displays the analysis results and allows users to submit feedback.

## Key Features

- **Hybrid Analysis:** Calculates a risk score based on text classification (TF-IDF + Logistic Regression) and hard-coded rules (heuristics).
- **Active Learning:** User feedback is stored and used to retrain the model.
- **Batch Retraining:** To optimize performance, the model retrains automatically after collecting a specific batch of new feedback (currently set to 5 samples).
- **Heuristic Detection:** Specifically flags indicators such as:

  - Typosquatting (e.g., `paypa1.com`).
  - Direct IP addresses in URLs.
  - Domain mismatches.
  - Urgency/Action keywords.

## Installation & Setup

### 1. Backend Setup

1.  Clone the repository.
2.  Create a virtual environment and install dependencies:
    ```
    pip install -r requirements.txt
    ```
3.  Initialize the model with seed data:
    ```
    python train.py
    ```
4.  Start the API server:
    ```
    python -m api.main
    ```
    _The server runs on port 5000 by default._

### 2. Expose Local Server

Since Gmail requires a public HTTPS endpoint, use **ngrok**:

```
ngrok http 5000
```

_Copy the HTTPS URL generated by ngrok._

### 3. Frontend Setup (Gmail Add-on)

1.  Go to [Google Apps Script](https://script.google.com/).
2.  Create a new project.
3.  Copy the contents of `gmail_addon/Code.gs` (provided in this repo) into the script editor.
4.  Update the `API_BASE_URL` variable at the top of the file with your ngrok URL.
5.  Update the `appsscript.json` manifest file with the provided manifest configuration.
6.  Deploy via **Deploy > Test deployments** and install the add-on.

## Gmail Add-on â€“ User Interface

Below are examples of the Gmail Add-on interface used to display phishing analysis results and collect user feedback.

![Suspicious Email Detection](https://res.cloudinary.com/dzdvtcsus/image/upload/v1765658388/897cd475-85b9-4361-96e1-7df2e664fc51.png)

![Phishing Detected](https://res.cloudinary.com/dzdvtcsus/image/upload/v1765657856/dd6e8a82-7394-49d5-8d7f-fbffab158fad.png)

![Safe Email](https://res.cloudinary.com/dzdvtcsus/image/upload/v1765657948/4520bffa-357e-4be4-9984-95ebc971584d.png)

## Scoring Overview

The final score is a weighted combination:

- **ML score**: `TF-IDF + LogisticRegression` probability for the phishing class
- **Rule score**: heuristics engine (URLs / domains / urgency patterns / etc.)

Weights are dynamic:

- severe heuristic signals can increase rule weight
- if the email was explicitly labeled by user feedback, `label_source=user_feedback` becomes authoritative

## Running Tests

`pytest -q`

Tests cover:

- `/health`, `/predict`, `/feedback` status codes + validation
- feedback rejects unknown ids
- payload validation behavior
- storage upsert behavior (dedup + scan_count)
- strict boolean parsing
